---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="My Timeline Digest">
	<div id="app"></div>

	<script>
		const app = document.getElementById('app');
		if (!app) throw new Error('App container missing');

		document.addEventListener('click', (event) => {
			const target = event.target;
			if (!(target instanceof HTMLElement)) return;
			const link = target.closest('a[data-nav]');
			if (!(link instanceof HTMLAnchorElement)) return;
			event.preventDefault();
			const url = new URL(link.href, window.location.origin);
			window.history.pushState({}, '', url.pathname);
			void renderByPath();
		});

		window.addEventListener('popstate', () => void renderByPath());
		void renderByPath();

		async function renderByPath() {
			const route = parseRoute(window.location.pathname);
			await renderDigestPage(route.day, route);
		}

		function parseRoute(pathname) {
			const unfilteredDayMatch = pathname.match(/^\/unfiltered\/(\d{4}-\d{2}-\d{2})$/);
			if (unfilteredDayMatch) {
				return { mode: 'unfiltered', day: unfilteredDayMatch[1], isHome: false };
			}

			if (pathname === '/unfiltered' || pathname === '/unfiltered/') {
				return { mode: 'unfiltered', day: getCurrentDateString(), isHome: true };
			}

			const filteredDayMatch = pathname.match(/^\/(\d{4}-\d{2}-\d{2})$/);
			if (filteredDayMatch) {
				return { mode: 'filtered', day: filteredDayMatch[1], isHome: false };
			}

			return { mode: 'filtered', day: getCurrentDateString(), isHome: true };
		}

		async function renderDigestPage(day, options) {
			const mode = options.mode || 'filtered';
			const isUnfiltered = mode === 'unfiltered';
			const daysResponse = await fetch(isUnfiltered ? '/api/unfiltered/days' : '/api/days');
			if (!daysResponse.ok) {
				app.innerHTML = renderError('Could not load day index.');
				return;
			}
			const daysPayload = await daysResponse.json();
			const days = daysPayload.days || [];
			const today = getCurrentDateString();
			const oldestDay = days[days.length - 1] || day;
			const digestResponse = await fetch(
				isUnfiltered ? `/api/unfiltered/day/${day}` : `/api/day/${day}`,
			);

			if (!digestResponse.ok) {
				app.innerHTML = `
					${options.isHome ? '' : `<p class="mb-3"><a data-nav href="${homePath(mode)}" class="text-sm text-accent hover:underline">← Back to today</a></p>`}
					${heroBlock('Daily Timeline Digest', `${day} · no digest yet`)}
					${dateControls(today, day, oldestDay, mode)}
					<div class="${panelClass()} p-4 text-sm text-text-soft">${isUnfiltered ? `No tweets found for ${escapeHtml(day)}.` : `No digest found for ${escapeHtml(day)}.`}</div>
				`;
				attachDatePickerHandler(mode);
				return;
			}

			const payload = await digestResponse.json();
			const highlights = (payload.highlights || []).map((row) => tweetDetailCard(row)).join('');
			const articles = (payload.articles || []).map((row) => articleCard(row)).join('');

			app.innerHTML = `
				${options.isHome ? '' : `<p class="mb-3"><a data-nav href="${homePath(mode)}" class="text-sm text-accent hover:underline">← Back to today</a></p>`}
				${heroBlock(payload.subject, `${payload.day} · ${payload.generated_at} · ${payload.model}`, payload)}
				${dateControls(today, payload.day, oldestDay, mode)}
				<div class="${panelClass()} p-4">
					<h2 class="mb-2 text-base font-semibold">Summary</h2>
					<p class="text-sm leading-relaxed text-text-main">${escapeHtml(payload.summary)}</p>
				</div>
				<h3 class="mb-2 mt-5 text-xs font-bold uppercase tracking-wider text-text-soft">${isUnfiltered ? 'Tweets' : 'Highlights'}</h3>
				${highlights ? `<div class="grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4">${highlights}</div>` : `<div class="${panelClass()} p-4 text-sm text-text-soft">${isUnfiltered ? 'No tweets captured.' : 'No relevant tweets selected.'}</div>`}
				<h3 class="mb-2 mt-5 text-xs font-bold uppercase tracking-wider text-text-soft">Articles</h3>
				${articles || `<div class="${panelClass()} p-4 text-sm text-text-soft">No article links.</div>`}
			`;

			attachDatePickerHandler(mode);
		}

		function dateControls(today, selectedDay, oldestDay, mode) {
			return `
				<div class="${panelClass()} mb-4 p-4">
					<div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
						<p class="text-sm text-text-main"><span class="font-semibold">Current date:</span> ${escapeHtml(today)}</p>
						<div class="flex items-center gap-2">
							${modeSwitch(mode, selectedDay)}
							<label class="text-sm text-text-soft">Pick date
								<input id="dayPicker" class="ml-2 rounded-md border border-border bg-panel-soft px-2 py-1 text-text-main outline-none focus:border-accent" type="date" min="${escapeHtml(oldestDay)}" max="${escapeHtml(today)}" value="${escapeHtml(selectedDay)}" />
							</label>
						</div>
					</div>
				</div>
			`;
		}

		function attachDatePickerHandler(mode) {
			const dayPicker = document.getElementById('dayPicker');
			if (dayPicker instanceof HTMLInputElement) {
				dayPicker.addEventListener('change', () => {
					if (!dayPicker.value) return;
					window.history.pushState({}, '', buildPath(mode, dayPicker.value));
					void renderByPath();
				});
			}
		}

		function modeSwitch(mode, selectedDay) {
			const filteredPath = buildPath('filtered', selectedDay);
			const unfilteredPath = buildPath('unfiltered', selectedDay);
			const filteredSelected = mode === 'filtered';
			const unfilteredSelected = mode === 'unfiltered';
			return `<div class="inline-flex overflow-hidden rounded-lg border border-border bg-panel-soft text-xs font-semibold">
				<a data-nav href="${filteredPath}" class="px-2.5 py-1.5 ${filteredSelected ? 'bg-accent-soft text-accent' : 'text-text-soft hover:text-text-main'}">Filtered</a>
				<a data-nav href="${unfilteredPath}" class="px-2.5 py-1.5 ${unfilteredSelected ? 'bg-accent-soft text-accent' : 'text-text-soft hover:text-text-main'}">Unfiltered</a>
			</div>`;
		}

		function buildPath(mode, day) {
			const today = getCurrentDateString();
			if (mode === 'unfiltered') {
				return day === today ? '/unfiltered' : `/unfiltered/${day}`;
			}
			return day === today ? '/' : `/${day}`;
		}

		function homePath(mode) {
			return mode === 'unfiltered' ? '/unfiltered' : '/';
		}

		function tweetDetailCard(row) {
			const item = row.data || {};
			const tweet = item.tweet || {};
			return `
				<article class="${panelClass()} flex h-full flex-col p-4">
					<div class="mb-2 flex items-center justify-between gap-2">
						<div class="text-sm font-semibold text-text-main">${escapeHtml(tweet.author || '')} <span class="font-normal text-text-soft">${escapeHtml(tweet.handle || '')}</span></div>
						<span class="rounded-full bg-accent-soft px-2.5 py-1 text-xs font-semibold text-accent">#${row.rank}</span>
					</div>
					<p class="rounded-xl border border-border bg-panel-soft p-3 text-sm leading-relaxed text-text-main">${escapeHtml(tweet.text || '')}</p>
					${renderTweetMedia(tweet)}
					<div class="mt-2 text-xs text-text-soft">Likes ${tweet.likes || 0} · Reposts ${tweet.reposts || 0} · Replies ${tweet.replies || 0}</div>
					${item.mainTakeaway ? `<div class="mt-3 rounded-xl border border-accent/40 bg-accent-soft p-3">
						<p class="text-[11px] font-bold uppercase tracking-wide text-accent">Takeaway</p>
						<p class="mt-1 text-sm font-medium leading-relaxed text-text-main">${escapeHtml(item.mainTakeaway || '')}</p>
					</div>` : ''}
					<p class="mt-3 text-xs"><a href="${escapeHtml(tweet.url || '#')}" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline">${escapeHtml(tweet.url || '')}</a></p>
				</article>
			`;
		}

		function renderTweetMedia(tweet) {
			const media = Array.isArray(tweet?.media) ? tweet.media : [];
			if (media.length === 0) {
				return '';
			}

			const tiles = media
				.slice(0, 4)
				.map((item) => {
					if (!item || (item.type !== 'photo' && item.type !== 'video')) {
						return '';
					}

					if (item.type === 'photo') {
						const imageUrl = sanitizeHttpUrl(item.url);
						if (!imageUrl) return '';
						const alt = escapeHtml(item.alt || 'Tweet image');
						return `<a href="${imageUrl}" target="_blank" rel="noopener noreferrer" class="group block overflow-hidden rounded-2xl border border-border bg-black/30">
							<img src="${imageUrl}" alt="${alt}" loading="lazy" referrerpolicy="no-referrer" class="h-48 w-full object-cover transition duration-200 group-hover:scale-[1.01]" />
						</a>`;
					}

					const poster = sanitizeHttpUrl(item.poster) || '';
					const source = sanitizeHttpUrl(item.url) || '';
					if (!source && !poster) return '';
					if (!source && poster) {
						return `<a href="${poster}" target="_blank" rel="noopener noreferrer" class="group relative block overflow-hidden rounded-2xl border border-border bg-black/30">
							<img src="${poster}" alt="Video poster" loading="lazy" referrerpolicy="no-referrer" class="h-48 w-full object-cover" />
							<span class="absolute bottom-2 right-2 rounded-full bg-black/70 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide text-white">video on X</span>
						</a>`;
					}
					return `<video controls preload="metadata" playsinline poster="${poster}" class="h-48 w-full rounded-2xl border border-border bg-black/60">
						<source src="${source}" type="video/mp4" />
					</video>`;
				})
				.join('');

			if (!tiles) {
				return '';
			}

			return `<div class="mt-3 grid gap-2 ${media.length > 1 ? 'sm:grid-cols-2' : 'grid-cols-1'}">${tiles}</div>`;
		}

		function articleCard(row) {
			const item = row.data || {};
			return `
				<article class="${panelClass()} p-4">
					<div class="mb-2 text-xs text-text-soft">#${row.rank}</div>
					<p><a href="${escapeHtml(item.url || '#')}" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-accent hover:underline">${escapeHtml(item.url || '')}</a></p>
					<p class="mt-1 text-sm text-text-soft">${escapeHtml(item.whyRelevant || '')}</p>
				</article>
			`;
		}

		function heroBlock(title, subtitle, payload = null) {
			return `
				<section class="${panelClass()} mb-4 overflow-hidden p-5">
					<div class="mb-2 inline-flex rounded-full bg-accent-soft px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider text-accent">timeline digest</div>
					<h1 class="text-2xl font-black leading-tight md:text-3xl">${escapeHtml(title)}</h1>
					<p class="mt-2 text-sm text-text-soft">${escapeHtml(subtitle)}</p>
				</section>
			`;
		}

		function panelClass() {
			return 'rounded-2xl border border-border bg-panel';
		}

		function renderError(message) {
			return `${heroBlock('Daily Timeline Digest', 'Precomputed highlights from your Following feed.')}
				<div class="${panelClass()} p-4">
					<p class="font-semibold text-text-main">Error</p>
					<p class="mt-1 text-sm text-text-soft">${escapeHtml(message)}</p>
					<p class="mt-2"><a data-nav href="/" class="text-sm text-accent hover:underline">Go back</a></p>
				</div>`;
		}

		function escapeHtml(text) {
			return String(text)
				.replaceAll('&', '&amp;')
				.replaceAll('<', '&lt;')
				.replaceAll('>', '&gt;')
				.replaceAll('"', '&quot;')
				.replaceAll("'", '&#39;');
		}

		function sanitizeHttpUrl(value) {
			if (typeof value !== 'string' || value.length === 0) {
				return '';
			}
			try {
				const parsed = new URL(value, window.location.origin);
				return parsed.protocol === 'http:' || parsed.protocol === 'https:' ? parsed.toString() : '';
			} catch {
				return '';
			}
		}

		function getCurrentDateString() {
			const now = new Date();
			const formatter = new Intl.DateTimeFormat('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
			return formatter.format(now);
		}
	</script>
</BaseLayout>
